from flask import Flask, render_template, request
import sqlite3
import wikipedia
import hashlib
from unidecode import unidecode

LOGFILE = "log.txt"

def double_up_quotes(s):
    return s.replace("'", "''")

def log_message(msg):
    with open(LOGFILE, 'ab') as f:
        f.write(msg)

app = Flask(__name__)

@app.route('/')
def index():
    return render_template("index.html")

@app.route('/login', methods=['POST'])
def login_page():
    user = request.form["username"]
    passwd = request.form["password"]

    # Neutralize single quotes to prevent SQLi
    user = double_up_quotes(user)
    passwd = double_up_quotes(passwd)

    # We like our log messages in ASCII, thank you very much!
    user = unidecode(user).encode()
    log_message(b"Login attempt as user: " + user)
    user = user.decode("utf-8")

    con = sqlite3.connect("accounts.db")
    cur = con.cursor()

    matches = cur.execute("SELECT * FROM users WHERE username='"+user+"' AND password='"+passwd+"';").fetchall()
    if matches == []:
        log_message(b"Login attempt failed.")
        return "Invalid credentials."
    else:
        log_message(b"Login success.")
        username = matches[0][0]
        secret_info = wikipedia.page(matches[0][2]).summary
        return render_template("homepage.html", user=username, secret=secret_info)


app.run(host='0.0.0.0')
